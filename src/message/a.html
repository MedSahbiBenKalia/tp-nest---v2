<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test WebSocket complet avec JWT</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
      body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
      .success { color: green; }
      .error { color: red; }
      .panel { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
      button { padding: 8px 15px; margin: 5px; cursor: pointer; }
      input, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
      #messages { height: 200px; overflow-y: scroll; border: 1px solid #eee; padding: 10px; }
      .message { margin-bottom: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; }
      .private { background: #fff0f0; border-left: 3px solid red; padding-left: 5px; }
      .reaction { display: inline-block; margin-right: 5px; cursor: pointer; }
      .comment { margin-left: 20px; padding: 5px; background: #f0f0f0; border-radius: 3px; }
  </style>
</head>
<body>
<h1>Test complet WebSocket avec JWT</h1>

<div class="panel">
  <h2>Connexion</h2>
  <p id="status">Connexion en cours...</p>
  <p id="userInfo"></p>
</div>

<div class="panel">
  <h2>Envoyer un message</h2>
  <textarea id="messageContent" placeholder="Votre message"></textarea>
  <div>
    <label><input type="checkbox" id="isPrivate"> Message priv√©</label>
    <input type="number" id="receiverId" placeholder="ID du destinataire" disabled>
  </div>
  <button id="sendMessageBtn">Envoyer</button>
</div>

<div class="panel">
  <h2>Messages re√ßus</h2>
  <div id="messages"></div>
</div>

<div class="panel">
  <h2>R√©actions</h2>
  <div>
    <input type="number" id="reactMessageId" placeholder="ID du message">
    <input type="text" id="reactionEmoji" placeholder="Emoji (ex: üëç)">
    <button id="addReactionBtn">Ajouter r√©action</button>
  </div>
</div>

<div class="panel">
  <h2>Commentaires</h2>
  <div>
    <input type="number" id="commentMessageId" placeholder="ID du message">
    <textarea id="commentContent" placeholder="Votre commentaire"></textarea>
    <button id="addCommentBtn">Ajouter commentaire</button>
  </div>
</div>

<div class="panel">
  <h2>Utilisateurs connect√©s</h2>
  <button id="getUsersBtn">Rafra√Æchir la liste</button>
  <ul id="connectedUsers"></ul>
</div>

<script>
  // Token JWT - remplacer par un vrai token valide
  const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJSYXllbiIsImVtYWlsIjoicmF5QGdtYWlsLmNvbSIsInJvbGUiOlsidXNlciJdLCJpYXQiOjE3NDY4MzY1NDMsImV4cCI6MTc0Njg0NzM0M30.TwzInVTJ_UK9yQtNMg6Q8APBv7qRetSPIy6hht1jSsU';

  // √âl√©ments DOM
  const statusEl = document.getElementById('status');
  const userInfoEl = document.getElementById('userInfo');
  const messagesEl = document.getElementById('messages');
  const connectedUsersEl = document.getElementById('connectedUsers');

  // Initialisation de la connexion WebSocket
  const socket = io('http://localhost:3000', {
    auth: {
      token: token
    }
  });

  // Gestion de la connexion
  socket.on('connect', () => {
    console.log('‚úÖ Connect√©');
    statusEl.textContent = '‚úÖ Connect√©';
    statusEl.className = 'success';

    // Afficher les infos utilisateur
    const decodedToken = parseJwt(token);
    userInfoEl.textContent = `Connect√© en tant que: ${decodedToken.username} (ID: ${decodedToken.id})`;

    // Demander la liste des utilisateurs connect√©s
    getConnectedUsers();
  });

  // Gestion des erreurs
  socket.on('connect_error', (err) => {
    console.error('‚ùå Erreur de connexion:', err.message);
    statusEl.textContent = '‚ùå Connexion √©chou√©e: ' + err.message;
    statusEl.className = 'error';
  });

  // Gestion de la d√©connexion
  socket.on('disconnect', () => {
    console.log('üîå D√©connect√©');
    statusEl.textContent = 'üîå D√©connect√©';
    statusEl.className = 'error';
  });

  // Recevoir un nouveau message
  socket.on('newMessage', (message) => {
    console.log('üì© Nouveau message:', message);
    displayMessage(message);
  });

  // Recevoir une mise √† jour de r√©action
  socket.on('messageReaction', (data) => {
    console.log('üîÑ R√©action mise √† jour:', data);
    updateMessageReactions(data.messageId, data.reactions);
  });

  // Recevoir un nouveau commentaire
  socket.on('messageComment', (data) => {
    console.log('üí¨ Commentaire ajout√©:', data);
    updateMessageComments(data.messageId, data.comments);
  });

  // Recevoir la liste des utilisateurs connect√©s
  socket.on('connectedUsers', (users) => {
    console.log('üë• Utilisateurs connect√©s:', users);
    displayConnectedUsers(users);
  });

  // √âcouteurs d'√©v√©nements pour les boutons
  document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
  document.getElementById('addReactionBtn').addEventListener('click', addReaction);
  document.getElementById('addCommentBtn').addEventListener('click', addComment);
  document.getElementById('getUsersBtn').addEventListener('click', getConnectedUsers);
  document.getElementById('isPrivate').addEventListener('change', function() {
    document.getElementById('receiverId').disabled = !this.checked;
  });

  // Fonction pour envoyer un message
  function sendMessage() {
    const content = document.getElementById('messageContent').value;
    const isPrivate = document.getElementById('isPrivate').checked;
    const receiverId = document.getElementById('receiverId').value;

    if (!content) {
      alert('Veuillez entrer un message');
      return;
    }

    socket.emit('sendMessage', {
      content: content,
      isPrivate: isPrivate,
      receiverId: isPrivate ? parseInt(receiverId) : null
    }, (response) => {
      if (response.status === 'success') {
        console.log('Message envoy√© avec succ√®s:', response.message);
        document.getElementById('messageContent').value = '';
      } else {
        console.error('Erreur lors de l\'envoi:', response.message);
        alert('Erreur: ' + response.message);
      }
    });
  }

  // Fonction pour ajouter une r√©action
  function addReaction() {
    const messageId = parseInt(document.getElementById('reactMessageId').value);
    const emoji = document.getElementById('reactionEmoji').value;

    if (!messageId || !emoji) {
      alert('Veuillez remplir tous les champs');
      return;
    }

    socket.emit('addReaction', {
      messageId: messageId,
      reaction: { emoji: emoji }
    }, (response) => {
      if (response.status === 'success') {
        console.log('R√©action ajout√©e:', response.reactions);
        document.getElementById('reactionEmoji').value = '';
      } else {
        console.error('Erreur:', response.message);
        alert('Erreur: ' + response.message);
      }
    });
  }

  // Fonction pour ajouter un commentaire
  function addComment() {
    const messageId = parseInt(document.getElementById('commentMessageId').value);
    const content = document.getElementById('commentContent').value;

    if (!messageId || !content) {
      alert('Veuillez remplir tous les champs');
      return;
    }

    socket.emit('addComment', {
      messageId: messageId,
      content: content
    }, (response) => {
      if (response.status === 'success') {
        console.log('Commentaire ajout√©:', response.comment);
        document.getElementById('commentContent').value = '';
      } else {
        console.error('Erreur:', response.message);
        alert('Erreur: ' + response.message);
      }
    });
  }

  // Fonction pour obtenir les utilisateurs connect√©s
  function getConnectedUsers() {
    socket.emit('getConnectedUsers');
  }

  // Fonction pour afficher un message
  function displayMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message' + (message.isPrivate ? ' private' : '');
    messageDiv.id = `message-${message.id}`;

    let html = `<strong>${message.sender.username}</strong> (${new Date(message.createdAt).toLocaleString()})`;
    html += `<p>${message.content}</p>`;
    html += `<div>ID: ${message.id} ${message.isPrivate ? '(Priv√©)' : ''}</div>`;

    if (message.reactions && message.reactions.length > 0) {
      html += '<div>R√©actions: ';
      message.reactions.forEach(r => {
        html += `<span class="reaction">${r.emoji} (${r.count})</span>`;
      });
      html += '</div>';
    }

    if (message.comments && message.comments.length > 0) {
      html += '<div>Commentaires:';
      message.comments.forEach(c => {
        html += `<div class="comment"><strong>${c.user.username}</strong>: ${c.content}</div>`;
      });
      html += '</div>';
    }

    messageDiv.innerHTML = html;
    messagesEl.prepend(messageDiv);
  }

  // Fonction pour mettre √† jour les r√©actions d'un message
  function updateMessageReactions(messageId, reactions) {
    const messageDiv = document.getElementById(`message-${messageId}`);
    if (messageDiv) {
      const reactionsDiv = messageDiv.querySelector('div:has(.reaction)');
      if (reactionsDiv) {
        let html = 'R√©actions: ';
        reactions.forEach(r => {
          html += `<span class="reaction">${r.emoji} (${r.count})</span>`;
        });
        reactionsDiv.innerHTML = html;
      }
    }
  }

  // Fonction pour mettre √† jour les commentaires d'un message
  function updateMessageComments(messageId, comments) {
    const messageDiv = document.getElementById(`message-${messageId}`);
    if (messageDiv) {
      let commentsDiv = messageDiv.querySelector('div:has(.comment)');
      if (!commentsDiv) {
        commentsDiv = document.createElement('div');
        commentsDiv.textContent = 'Commentaires:';
        messageDiv.appendChild(commentsDiv);
      }

      // Afficher tous les commentaires
      commentsDiv.innerHTML = 'Commentaires:';
      comments.forEach(c => {
        commentsDiv.innerHTML += `<div class="comment"><strong>${c.user.username}</strong>: ${c.content}</div>`;
      });
    }
  }

  // Fonction pour afficher les utilisateurs connect√©s
  function displayConnectedUsers(users) {
    connectedUsersEl.innerHTML = '';
    if (users.length === 0) {
      connectedUsersEl.innerHTML = '<li>Aucun utilisateur connect√©</li>';
      return;
    }

    users.forEach(user => {
      const li = document.createElement('li');
      li.textContent = `${user.username} (ID: ${user.userId})`;
      connectedUsersEl.appendChild(li);
    });
  }

  // Fonction pour d√©coder le token JWT
  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    } catch (e) {
      console.error('Erreur de d√©codage du token:', e);
      return {};
    }
  }
</script>
</body>
</html>